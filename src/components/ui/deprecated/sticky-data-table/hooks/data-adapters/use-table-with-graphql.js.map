{"version":3,"file":"use-table-with-graphql.js","sourceRoot":"/","sources":["other-repos/demo-repo/src/components/ui/deprecated/sticky-data-table/hooks/data-adapters/use-table-with-graphql.ts"],"names":[],"mappings":"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","sourcesContent":["'use client'\n\n/**\n * useTableWithGraphQL - Apollo GraphQL Data Adapter\n *\n * Integrates Apollo GraphQL queries with StickyDataTable, providing:\n * - Auto-skeleton on initial load\n * - Auto-skeleton on filter/variable changes\n * - Auto-skeleton on refetch\n * - Infinite scroll integration\n * - Minimum loading duration to prevent skeleton flash\n *\n * @module hooks/data-adapters/use-table-with-graphql\n *\n * @example Basic Usage\n * ```tsx\n * const { data, loading } = useGetPartnersQuery({ variables: { first: 50 } })\n *\n * const { tableProps, infiniteScrollProps } = useTableWithGraphQL({\n *   data: data?.partners?.edges?.map(e => e.node) ?? [],\n *   loading,\n *   hasNextPage: data?.partners?.hasNextPage ?? false,\n *   fetchMore: () => fetchMore({ variables: { after: lastCursor } }),\n * })\n *\n * <StickyDataTable\n *   {...tableProps}\n *   columns={columns}\n *   renderCell={renderCell}\n *   infiniteScroll={infiniteScrollProps}\n * />\n * ```\n *\n * @example With Filters\n * ```tsx\n * const [filters, setFilters] = useState({ status: 'active' })\n *\n * const { tableProps } = useTableWithGraphQL({\n *   data: items,\n *   loading,\n *   filterDependencies: [filters], // Triggers skeleton when filters change\n * })\n * ```\n */\n\nimport { useCallback, useEffect, useRef, useState } from 'react'\nimport type { InfiniteScrollConfig } from '../../types'\nimport { useTableLoadingState, type TableLoadingStateOptions } from './use-table-loading-state'\n\n// ============================================================================\n// Types\n// ============================================================================\n\nexport interface UseTableWithGraphQLOptions<TData> extends TableLoadingStateOptions {\n  /**\n   * The data array to display in the table\n   */\n  data: TData[]\n\n  /**\n   * Apollo loading state from useQuery\n   */\n  loading: boolean\n\n  /**\n   * Whether more pages are available (for infinite scroll)\n   */\n  hasNextPage?: boolean\n\n  /**\n   * Function to fetch next page (Apollo fetchMore)\n   */\n  fetchMore?: () => Promise<unknown> | void\n\n  /**\n   * Dependencies that trigger filter loading state when changed\n   * Example: [searchTerm, statusFilter, dateRange]\n   */\n  filterDependencies?: unknown[]\n\n  /**\n   * Number of skeleton rows during load-more\n   * @default 5\n   */\n  skeletonRowCount?: number\n\n  /**\n   * Threshold in pixels from bottom to trigger load more\n   * @default 200\n   */\n  loadMoreThreshold?: number\n\n  /**\n   * Called when an error occurs during fetchMore\n   */\n  onFetchMoreError?: (error: unknown) => void\n}\n\nexport interface UseTableWithGraphQLReturn<TData> {\n  /**\n   * Props to spread on StickyDataTable\n   */\n  tableProps: {\n    data: TData[]\n    isLoading: boolean\n  }\n\n  /**\n   * Props for infinite scroll (spread on infiniteScroll prop)\n   * Only provided if hasNextPage and fetchMore are configured\n   */\n  infiniteScrollProps?: InfiniteScrollConfig\n\n  /**\n   * Current loading states for custom UI\n   */\n  loadingStates: {\n    isLoading: boolean\n    isInitialLoading: boolean\n    isFiltering: boolean\n    isRefetching: boolean\n    isLoadingMore: boolean\n    hasInitialData: boolean\n  }\n\n  /**\n   * Manual refetch with auto-skeleton\n   */\n  refetchWithSkeleton: (refetchFn: () => Promise<unknown>) => Promise<void>\n}\n\n// ============================================================================\n// Hook Implementation\n// ============================================================================\n\nexport function useTableWithGraphQL<TData>({\n  data,\n  loading,\n  hasNextPage = false,\n  fetchMore,\n  filterDependencies = [],\n  skeletonRowCount = 5,\n  loadMoreThreshold = 200,\n  minimumLoadingDuration = 300,\n  showSkeletonOnMount = true,\n  loadingDebounce = 50,\n  onFetchMoreError,\n}: UseTableWithGraphQLOptions<TData>): UseTableWithGraphQLReturn<TData> {\n  // Core loading state management\n  const { state, actions } = useTableLoadingState({\n    minimumLoadingDuration,\n    showSkeletonOnMount,\n    loadingDebounce,\n  })\n\n  // Infinite scroll state\n  const [isLoadingMore, setIsLoadingMore] = useState(false)\n  // Use ref to prevent race conditions in handleLoadMore\n  const isLoadingMoreRef = useRef(false)\n\n  // Track previous values for change detection\n  const prevLoadingRef = useRef(loading)\n  const prevFilterDepsRef = useRef(filterDependencies)\n  const isFirstRenderRef = useRef(true)\n  const loadingCompleteRef = useRef<(() => void) | null>(null)\n\n  // -------------------------------------------------------------------------\n  // Handle Apollo loading state changes\n  // -------------------------------------------------------------------------\n  useEffect(() => {\n    const wasLoading = prevLoadingRef.current\n    const isNowLoading = loading\n\n    // Detect loading started\n    if (!wasLoading && isNowLoading) {\n      // Don't trigger loading states for:\n      // 1. Infinite scroll (handled separately)\n      // 2. Background refetches when we already have data (prevents flash)\n      if (isLoadingMore) {\n        prevLoadingRef.current = loading\n        return\n      }\n\n      // Only trigger loading for INITIAL load (no data yet)\n      // Filter changes are handled by the filter dependency effect\n      // This prevents Apollo background refetches from causing skeleton flash\n      const hasData = data.length > 0\n      if (!hasData) {\n        loadingCompleteRef.current = actions.startLoading('initial')\n      }\n      // Note: We intentionally don't trigger 'refetch' loading here\n      // to avoid flashing on Apollo cache updates / background refetches\n    }\n\n    // Detect loading completed\n    if (wasLoading && !isNowLoading) {\n      // Mark initial data as loaded on first successful fetch\n      if (!state.hasInitialData && data.length > 0) {\n        actions.markInitialDataLoaded()\n      }\n\n      // Complete the loading state\n      if (loadingCompleteRef.current) {\n        loadingCompleteRef.current()\n        loadingCompleteRef.current = null\n      }\n    }\n\n    prevLoadingRef.current = loading\n  }, [loading, data.length, state.hasInitialData, actions, isLoadingMore])\n\n  // -------------------------------------------------------------------------\n  // Handle filter dependency changes\n  // -------------------------------------------------------------------------\n  useEffect(() => {\n    // Skip first render\n    if (isFirstRenderRef.current) {\n      isFirstRenderRef.current = false\n      prevFilterDepsRef.current = filterDependencies\n      return\n    }\n\n    // Check if filter dependencies changed\n    const prevDeps = prevFilterDepsRef.current\n    const hasChanged = filterDependencies.some(\n      (dep, index) => dep !== prevDeps[index]\n    )\n\n    if (hasChanged && state.hasInitialData) {\n      // Filter changed after initial load - show filter skeleton\n      loadingCompleteRef.current = actions.startLoading('filter')\n    }\n\n    prevFilterDepsRef.current = filterDependencies\n  }, [filterDependencies, state.hasInitialData, actions])\n\n  // Cleanup loading complete callback when loading stops\n  useEffect(() => {\n    if (!loading && loadingCompleteRef.current) {\n      loadingCompleteRef.current()\n      loadingCompleteRef.current = null\n    }\n  }, [loading])\n\n  // -------------------------------------------------------------------------\n  // Infinite scroll handler\n  // -------------------------------------------------------------------------\n  const handleLoadMore = useCallback(async () => {\n    // Use ref for guard to prevent race conditions from stale closures\n    if (!fetchMore || isLoadingMoreRef.current) {\n      return\n    }\n\n    // Set both ref and state\n    isLoadingMoreRef.current = true\n    setIsLoadingMore(true)\n    const startTime = Date.now()\n\n    try {\n      await fetchMore()\n    } catch (error) {\n      console.error('Failed to load more:', error)\n      onFetchMoreError?.(error)\n    } finally {\n      // Ensure minimum display time for skeleton\n      // Use a shorter duration for load-more (150ms) to feel responsive\n      const loadMoreMinDuration = Math.min(150, minimumLoadingDuration)\n      const elapsed = Date.now() - startTime\n      const remaining = Math.max(0, loadMoreMinDuration - elapsed)\n\n      const completeLoading = () => {\n        isLoadingMoreRef.current = false\n        setIsLoadingMore(false)\n      }\n\n      if (remaining > 0) {\n        setTimeout(completeLoading, remaining)\n      } else {\n        completeLoading()\n      }\n    }\n  }, [fetchMore, minimumLoadingDuration, onFetchMoreError])\n\n  // -------------------------------------------------------------------------\n  // Manual refetch with skeleton\n  // -------------------------------------------------------------------------\n  const refetchWithSkeleton = useCallback(\n    async (refetchFn: () => Promise<unknown>) => {\n      await actions.withLoading('refetch', refetchFn)\n    },\n    [actions]\n  )\n\n  // -------------------------------------------------------------------------\n  // Build infinite scroll config\n  // -------------------------------------------------------------------------\n  const infiniteScrollProps: InfiniteScrollConfig | undefined =\n    fetchMore && hasNextPage !== undefined\n      ? {\n          hasNextPage,\n          isLoadingMore,\n          onLoadMore: handleLoadMore,\n          skeletonRowCount,\n          threshold: loadMoreThreshold,\n        }\n      : undefined\n\n  // -------------------------------------------------------------------------\n  // Compute final loading state\n  // -------------------------------------------------------------------------\n  // Show skeleton when:\n  // 1. Initial loading (no data yet)\n  // 2. Filter change in progress\n  // 3. Refetch in progress (optional - some UIs prefer to show stale data)\n  const shouldShowSkeleton = state.isLoading && (\n    !state.hasInitialData || // Initial load\n    state.isFiltering ||      // Filter change\n    (state.isRefetching && data.length === 0) // Refetch with no data\n  )\n\n  return {\n    tableProps: {\n      data,\n      isLoading: shouldShowSkeleton,\n    },\n    infiniteScrollProps,\n    loadingStates: {\n      isLoading: state.isLoading,\n      isInitialLoading: !state.hasInitialData && state.isLoading,\n      isFiltering: state.isFiltering,\n      isRefetching: state.isRefetching,\n      isLoadingMore,\n      hasInitialData: state.hasInitialData,\n    },\n    refetchWithSkeleton,\n  }\n}\n"]}
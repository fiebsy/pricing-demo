{"version":3,"file":"use-table-with-graphql.js","sourceRoot":"/","sources":["other-repos/demo-repo/src/components/ui/prod/data/sticky-data-table/hooks/data-adapters/use-table-with-graphql.ts"],"names":[],"mappings":";AAAA,YAAY,CAAA;;;AAEZ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;GAyCG;AAEH,iCAAgE;AAEhE,uEAA+F;AAsG/F,+EAA+E;AAC/E,sBAAsB;AACtB,+EAA+E;AAE/E,SAAgB,mBAAmB,CAAQ,EACzC,IAAI,EACJ,OAAO,EACP,WAAW,GAAG,KAAK,EACnB,SAAS,EACT,kBAAkB,GAAG,EAAE,EACvB,gBAAgB,GAAG,CAAC,EACpB,iBAAiB,GAAG,GAAG,EACvB,sBAAsB,GAAG,GAAG,EAC5B,mBAAmB,GAAG,IAAI,EAC1B,eAAe,GAAG,EAAE,EACpB,gBAAgB,EAChB,kBAAkB,GAAG,IAAI,GACS;IAClC,gCAAgC;IAChC,MAAM,EAAE,KAAK,EAAE,OAAO,EAAE,GAAG,IAAA,8CAAoB,EAAC;QAC9C,sBAAsB;QACtB,mBAAmB;QACnB,eAAe;KAChB,CAAC,CAAA;IAEF,mEAAmE;IACnE,MAAM,CAAC,aAAa,EAAE,gBAAgB,CAAC,GAAG,IAAA,gBAAQ,EAAC,KAAK,CAAC,CAAA;IACzD,MAAM,gBAAgB,GAAG,IAAA,cAAM,EAAC,KAAK,CAAC,CAAA;IACtC,oEAAoE;IACpE,MAAM,cAAc,GAAG,IAAA,cAAM,EAAC,WAAW,CAAC,CAAA;IAC1C,cAAc,CAAC,OAAO,GAAG,WAAW,CAAA;IAEpC,6CAA6C;IAC7C,MAAM,cAAc,GAAG,IAAA,cAAM,EAAC,OAAO,CAAC,CAAA;IACtC,MAAM,iBAAiB,GAAG,IAAA,cAAM,EAAC,kBAAkB,CAAC,CAAA;IACpD,MAAM,gBAAgB,GAAG,IAAA,cAAM,EAAC,IAAI,CAAC,CAAA;IACrC,MAAM,kBAAkB,GAAG,IAAA,cAAM,EAAsB,IAAI,CAAC,CAAA;IAE5D,yEAAyE;IACzE,MAAM,iBAAiB,GAAG,IAAA,cAAM,EAAa,GAAG,EAAE,GAAE,CAAC,CAAC,CAAA;IAEtD,4DAA4D;IAC5D,MAAM,qBAAqB,GAAG,IAAA,cAAM,EAAwB,IAAI,CAAC,CAAA;IAEjE,4EAA4E;IAC5E,sCAAsC;IACtC,4EAA4E;IAC5E,IAAA,iBAAS,EAAC,GAAG,EAAE;QACb,MAAM,UAAU,GAAG,cAAc,CAAC,OAAO,CAAA;QACzC,MAAM,YAAY,GAAG,OAAO,CAAA;QAE5B,yBAAyB;QACzB,IAAI,CAAC,UAAU,IAAI,YAAY,EAAE,CAAC;YAChC,oCAAoC;YACpC,0CAA0C;YAC1C,qEAAqE;YACrE,wEAAwE;YACxE,4DAA4D;YAC5D,IAAI,gBAAgB,CAAC,OAAO,EAAE,CAAC;gBAC7B,cAAc,CAAC,OAAO,GAAG,OAAO,CAAA;gBAChC,OAAM;YACR,CAAC;YAED,sDAAsD;YACtD,6DAA6D;YAC7D,wEAAwE;YACxE,MAAM,OAAO,GAAG,IAAI,CAAC,MAAM,GAAG,CAAC,CAAA;YAC/B,IAAI,CAAC,OAAO,EAAE,CAAC;gBACb,kBAAkB,CAAC,OAAO,GAAG,OAAO,CAAC,YAAY,CAAC,SAAS,CAAC,CAAA;YAC9D,CAAC;YACD,8DAA8D;YAC9D,mEAAmE;QACrE,CAAC;QAED,2BAA2B;QAC3B,IAAI,UAAU,IAAI,CAAC,YAAY,EAAE,CAAC;YAChC,wDAAwD;YACxD,IAAI,CAAC,KAAK,CAAC,cAAc,IAAI,IAAI,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;gBAC7C,OAAO,CAAC,qBAAqB,EAAE,CAAA;YACjC,CAAC;YAED,6BAA6B;YAC7B,IAAI,kBAAkB,CAAC,OAAO,EAAE,CAAC;gBAC/B,kBAAkB,CAAC,OAAO,EAAE,CAAA;gBAC5B,kBAAkB,CAAC,OAAO,GAAG,IAAI,CAAA;YACnC,CAAC;QACH,CAAC;QAED,cAAc,CAAC,OAAO,GAAG,OAAO,CAAA;IAClC,CAAC,EAAE,CAAC,OAAO,EAAE,IAAI,CAAC,MAAM,EAAE,KAAK,CAAC,cAAc,EAAE,KAAK,CAAC,WAAW,EAAE,OAAO,CAAC,CAAC,CAAA;IAE5E,4EAA4E;IAC5E,mCAAmC;IACnC,4EAA4E;IAC5E,IAAA,iBAAS,EAAC,GAAG,EAAE;QACb,oBAAoB;QACpB,IAAI,gBAAgB,CAAC,OAAO,EAAE,CAAC;YAC7B,gBAAgB,CAAC,OAAO,GAAG,KAAK,CAAA;YAChC,iBAAiB,CAAC,OAAO,GAAG,kBAAkB,CAAA;YAC9C,OAAM;QACR,CAAC;QAED,uCAAuC;QACvC,MAAM,QAAQ,GAAG,iBAAiB,CAAC,OAAO,CAAA;QAC1C,MAAM,UAAU,GAAG,kBAAkB,CAAC,IAAI,CACxC,CAAC,GAAG,EAAE,KAAK,EAAE,EAAE,CAAC,GAAG,KAAK,QAAQ,CAAC,KAAK,CAAC,CACxC,CAAA;QAED,IAAI,UAAU,IAAI,KAAK,CAAC,cAAc,EAAE,CAAC;YACvC,2DAA2D;YAC3D,kBAAkB,CAAC,OAAO,GAAG,OAAO,CAAC,YAAY,CAAC,QAAQ,CAAC,CAAA;QAC7D,CAAC;QAED,iBAAiB,CAAC,OAAO,GAAG,kBAAkB,CAAA;IAChD,CAAC,EAAE,CAAC,kBAAkB,EAAE,KAAK,CAAC,cAAc,EAAE,OAAO,CAAC,CAAC,CAAA;IAEvD,uDAAuD;IACvD,iEAAiE;IACjE,IAAA,iBAAS,EAAC,GAAG,EAAE;QACb,4DAA4D;QAC5D,IAAI,qBAAqB,CAAC,OAAO,EAAE,CAAC;YAClC,YAAY,CAAC,qBAAqB,CAAC,OAAO,CAAC,CAAA;YAC3C,qBAAqB,CAAC,OAAO,GAAG,IAAI,CAAA;QACtC,CAAC;QAED,IAAI,CAAC,OAAO,IAAI,kBAAkB,CAAC,OAAO,EAAE,CAAC;YAC3C,MAAM,QAAQ,GAAG,kBAAkB,CAAC,OAAO,CAAA;YAC3C,kBAAkB,CAAC,OAAO,GAAG,IAAI,CAAA;YAEjC,mDAAmD;YACnD,+DAA+D;YAC/D,MAAM,YAAY,GAAG,EAAE,CAAA,CAAC,KAAK;YAC7B,qBAAqB,CAAC,OAAO,GAAG,UAAU,CAAC,GAAG,EAAE;gBAC9C,qBAAqB,CAAC,OAAO,GAAG,IAAI,CAAA;gBACpC,QAAQ,EAAE,CAAA;YACZ,CAAC,EAAE,YAAY,CAAC,CAAA;QAClB,CAAC;IACH,CAAC,EAAE,CAAC,OAAO,CAAC,CAAC,CAAA;IAEb,2BAA2B;IAC3B,IAAA,iBAAS,EAAC,GAAG,EAAE;QACb,OAAO,GAAG,EAAE;YACV,IAAI,qBAAqB,CAAC,OAAO,EAAE,CAAC;gBAClC,YAAY,CAAC,qBAAqB,CAAC,OAAO,CAAC,CAAA;YAC7C,CAAC;QACH,CAAC,CAAA;IACH,CAAC,EAAE,EAAE,CAAC,CAAA;IAEN,4EAA4E;IAC5E,mEAAmE;IACnE,sEAAsE;IACtE,4EAA4E;IAC5E,MAAM,cAAc,GAAG,IAAA,mBAAW,EAAC,KAAK,IAAI,EAAE;QAC5C,kCAAkC;QAClC,IAAI,CAAC,SAAS,IAAI,gBAAgB,CAAC,OAAO,EAAE,CAAC;YAC3C,OAAM;QACR,CAAC;QAED,oBAAoB;QACpB,gBAAgB,CAAC,OAAO,GAAG,IAAI,CAAA;QAC/B,gBAAgB,CAAC,IAAI,CAAC,CAAA;QAEtB,IAAI,CAAC;YACH,MAAM,SAAS,EAAE,CAAA;QACnB,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,gBAAgB,EAAE,CAAC,KAAK,CAAC,CAAA;YACzB,2CAA2C;YAC3C,gBAAgB,CAAC,OAAO,GAAG,KAAK,CAAA;YAChC,gBAAgB,CAAC,KAAK,CAAC,CAAA;YACvB,OAAM;QACR,CAAC;QAED,gBAAgB;QAChB,gBAAgB,CAAC,OAAO,GAAG,KAAK,CAAA;QAEhC,kEAAkE;QAClE,8DAA8D;QAC9D,oEAAoE;QACpE,UAAU,CAAC,GAAG,EAAE;YACd,IAAI,cAAc,CAAC,OAAO,IAAI,CAAC,gBAAgB,CAAC,OAAO,EAAE,CAAC;gBACxD,wDAAwD;gBACxD,iBAAiB,CAAC,OAAO,EAAE,CAAA;YAC7B,CAAC;iBAAM,IAAI,CAAC,cAAc,CAAC,OAAO,EAAE,CAAC;gBACnC,gBAAgB,CAAC,KAAK,CAAC,CAAA;YACzB,CAAC;QACH,CAAC,EAAE,EAAE,CAAC,CAAA;IACR,CAAC,EAAE,CAAC,SAAS,EAAE,gBAAgB,CAAC,CAAC,CAAA;IAEjC,8CAA8C;IAC9C,iBAAiB,CAAC,OAAO,GAAG,cAAc,CAAA;IAE1C,sEAAsE;IACtE,IAAA,iBAAS,EAAC,GAAG,EAAE;QACb,IAAI,CAAC,WAAW,IAAI,aAAa,EAAE,CAAC;YAClC,gBAAgB,CAAC,KAAK,CAAC,CAAA;QACzB,CAAC;IACH,CAAC,EAAE,CAAC,WAAW,EAAE,aAAa,CAAC,CAAC,CAAA;IAEhC,4EAA4E;IAC5E,+BAA+B;IAC/B,4EAA4E;IAC5E,MAAM,mBAAmB,GAAG,IAAA,mBAAW,EACrC,KAAK,EAAE,SAAiC,EAAE,EAAE;QAC1C,MAAM,OAAO,CAAC,WAAW,CAAC,SAAS,EAAE,SAAS,CAAC,CAAA;IACjD,CAAC,EACD,CAAC,OAAO,CAAC,CACV,CAAA;IAED,4EAA4E;IAC5E,+BAA+B;IAC/B,4EAA4E;IAC5E,MAAM,mBAAmB,GACvB,SAAS,IAAI,WAAW,KAAK,SAAS;QACpC,CAAC,CAAC;YACE,WAAW;YACX,aAAa;YACb,UAAU,EAAE,cAAc;YAC1B,gBAAgB;YAChB,SAAS,EAAE,iBAAiB;SAC7B;QACH,CAAC,CAAC,SAAS,CAAA;IAEf,4EAA4E;IAC5E,8BAA8B;IAC9B,4EAA4E;IAC5E,2BAA2B;IAC3B,mCAAmC;IACnC,+BAA+B;IAC/B,sCAAsC;IACtC,uGAAuG;IACvG,MAAM,kBAAkB,GAAG,CACzB,KAAK,CAAC,SAAS,IAAI,CACjB,CAAC,KAAK,CAAC,cAAc,IAAI,eAAe;QACxC,KAAK,CAAC,WAAW,IAAS,gBAAgB;QAC1C,CAAC,KAAK,CAAC,YAAY,IAAI,IAAI,CAAC,MAAM,KAAK,CAAC,CAAC,CAAC,uBAAuB;KAClE,CACF,CAAA;IAED,sEAAsE;IACtE,4EAA4E;IAC5E,MAAM,aAAa,GAAG,kBAAkB,IAAI,kBAAkB,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,IAAI,CAAA;IAE1E,OAAO;QACL,UAAU,EAAE;YACV,IAAI,EAAE,aAAa;YACnB,SAAS,EAAE,kBAAkB;SAC9B;QACD,iDAAiD;QACjD,OAAO,EAAE,IAAI;QACb,mBAAmB;QACnB,aAAa,EAAE;YACb,SAAS,EAAE,KAAK,CAAC,SAAS;YAC1B,gBAAgB,EAAE,CAAC,KAAK,CAAC,cAAc,IAAI,KAAK,CAAC,SAAS;YAC1D,WAAW,EAAE,KAAK,CAAC,WAAW;YAC9B,YAAY,EAAE,KAAK,CAAC,YAAY;YAChC,aAAa;YACb,cAAc,EAAE,aAAa,IAAI,WAAW,EAAE,gCAAgC;YAC9E,cAAc,EAAE,KAAK,CAAC,cAAc;SACrC;QACD,mBAAmB;KACpB,CAAA;AACH,CAAC;AAjQD,kDAiQC","sourcesContent":["'use client'\n\n/**\n * useTableWithGraphQL - Apollo GraphQL Data Adapter\n *\n * Integrates Apollo GraphQL queries with StickyDataTable, providing:\n * - Auto-skeleton on initial load\n * - Auto-skeleton on filter/variable changes\n * - Auto-skeleton on refetch\n * - Infinite scroll integration\n * - Minimum loading duration to prevent skeleton flash\n *\n * @module hooks/data-adapters/use-table-with-graphql\n *\n * @example Basic Usage\n * ```tsx\n * const { data, loading } = useGetPartnersQuery({ variables: { first: 50 } })\n *\n * const { tableProps, infiniteScrollProps } = useTableWithGraphQL({\n *   data: data?.partners?.edges?.map(e => e.node) ?? [],\n *   loading,\n *   hasNextPage: data?.partners?.hasNextPage ?? false,\n *   fetchMore: () => fetchMore({ variables: { after: lastCursor } }),\n * })\n *\n * <StickyDataTable\n *   {...tableProps}\n *   columns={columns}\n *   renderCell={renderCell}\n *   infiniteScroll={infiniteScrollProps}\n * />\n * ```\n *\n * @example With Filters\n * ```tsx\n * const [filters, setFilters] = useState({ status: 'active' })\n *\n * const { tableProps } = useTableWithGraphQL({\n *   data: items,\n *   loading,\n *   filterDependencies: [filters], // Triggers skeleton when filters change\n * })\n * ```\n */\n\nimport { useCallback, useEffect, useRef, useState } from 'react'\nimport type { InfiniteScrollConfig } from '../../types'\nimport { useTableLoadingState, type TableLoadingStateOptions } from './use-table-loading-state'\n\n// ============================================================================\n// Types\n// ============================================================================\n\nexport interface UseTableWithGraphQLOptions<TData> extends TableLoadingStateOptions {\n  /**\n   * The data array to display in the table\n   */\n  data: TData[]\n\n  /**\n   * Apollo loading state from useQuery\n   */\n  loading: boolean\n\n  /**\n   * Whether more pages are available (for infinite scroll)\n   */\n  hasNextPage?: boolean\n\n  /**\n   * Function to fetch next page (Apollo fetchMore)\n   */\n  fetchMore?: () => Promise<unknown> | void\n\n  /**\n   * Dependencies that trigger filter loading state when changed\n   * Example: [searchTerm, statusFilter, dateRange]\n   */\n  filterDependencies?: unknown[]\n\n  /**\n   * Number of skeleton rows during load-more\n   * @default 5\n   */\n  skeletonRowCount?: number\n\n  /**\n   * Threshold in pixels from bottom to trigger load more\n   * @default 200\n   */\n  loadMoreThreshold?: number\n\n  /**\n   * Called when an error occurs during fetchMore\n   */\n  onFetchMoreError?: (error: unknown) => void\n\n  /**\n   * Automatically clear tableProps.data during filter/initial loading\n   * to trigger skeleton display. When true (default), consumers just\n   * spread tableProps and skeletons work automatically.\n   *\n   * Set to false if you need to keep stale data visible during loading.\n   * @default true\n   */\n  clearDataOnLoading?: boolean\n}\n\nexport interface UseTableWithGraphQLReturn<TData> {\n  /**\n   * Props to spread on StickyDataTable.\n   * data is automatically cleared during loading when clearDataOnLoading=true (default).\n   */\n  tableProps: {\n    data: TData[]\n    isLoading: boolean\n  }\n\n  /**\n   * Original data array (not cleared during loading).\n   * Use this for counts, exports, or when you need access to data during loading.\n   */\n  rawData: TData[]\n\n  /**\n   * Props for infinite scroll (spread on infiniteScroll prop)\n   * Only provided if hasNextPage and fetchMore are configured\n   */\n  infiniteScrollProps?: InfiniteScrollConfig\n\n  /**\n   * Current loading states for custom UI\n   */\n  loadingStates: {\n    isLoading: boolean\n    isInitialLoading: boolean\n    isFiltering: boolean\n    isRefetching: boolean\n    isLoadingMore: boolean\n    isBatchLoading: boolean\n    hasInitialData: boolean\n  }\n\n  /**\n   * Manual refetch with auto-skeleton\n   */\n  refetchWithSkeleton: (refetchFn: () => Promise<unknown>) => Promise<void>\n}\n\n// ============================================================================\n// Hook Implementation\n// ============================================================================\n\nexport function useTableWithGraphQL<TData>({\n  data,\n  loading,\n  hasNextPage = false,\n  fetchMore,\n  filterDependencies = [],\n  skeletonRowCount = 5,\n  loadMoreThreshold = 200,\n  minimumLoadingDuration = 300,\n  showSkeletonOnMount = true,\n  loadingDebounce = 50,\n  onFetchMoreError,\n  clearDataOnLoading = true,\n}: UseTableWithGraphQLOptions<TData>): UseTableWithGraphQLReturn<TData> {\n  // Core loading state management\n  const { state, actions } = useTableLoadingState({\n    minimumLoadingDuration,\n    showSkeletonOnMount,\n    loadingDebounce,\n  })\n\n  // Infinite scroll state - simplified for reliable skeleton display\n  const [isLoadingMore, setIsLoadingMore] = useState(false)\n  const isLoadingMoreRef = useRef(false)\n  // Track current hasNextPage value (ref avoids stale closure issues)\n  const hasNextPageRef = useRef(hasNextPage)\n  hasNextPageRef.current = hasNextPage\n\n  // Track previous values for change detection\n  const prevLoadingRef = useRef(loading)\n  const prevFilterDepsRef = useRef(filterDependencies)\n  const isFirstRenderRef = useRef(true)\n  const loadingCompleteRef = useRef<(() => void) | null>(null)\n\n  // Ref for handleLoadMore to enable recursive calls without stale closure\n  const handleLoadMoreRef = useRef<() => void>(() => {})\n\n  // Track settle timer for preventing premature skeleton hide\n  const loadingSettleTimerRef = useRef<NodeJS.Timeout | null>(null)\n\n  // -------------------------------------------------------------------------\n  // Handle Apollo loading state changes\n  // -------------------------------------------------------------------------\n  useEffect(() => {\n    const wasLoading = prevLoadingRef.current\n    const isNowLoading = loading\n\n    // Detect loading started\n    if (!wasLoading && isNowLoading) {\n      // Don't trigger loading states for:\n      // 1. Infinite scroll (handled separately)\n      // 2. Background refetches when we already have data (prevents flash)\n      // Note: Use ref instead of state to avoid race condition where Apollo's\n      // loading state changes before React state update completes\n      if (isLoadingMoreRef.current) {\n        prevLoadingRef.current = loading\n        return\n      }\n\n      // Only trigger loading for INITIAL load (no data yet)\n      // Filter changes are handled by the filter dependency effect\n      // This prevents Apollo background refetches from causing skeleton flash\n      const hasData = data.length > 0\n      if (!hasData) {\n        loadingCompleteRef.current = actions.startLoading('initial')\n      }\n      // Note: We intentionally don't trigger 'refetch' loading here\n      // to avoid flashing on Apollo cache updates / background refetches\n    }\n\n    // Detect loading completed\n    if (wasLoading && !isNowLoading) {\n      // Mark initial data as loaded on first successful fetch\n      if (!state.hasInitialData && data.length > 0) {\n        actions.markInitialDataLoaded()\n      }\n\n      // Complete the loading state\n      if (loadingCompleteRef.current) {\n        loadingCompleteRef.current()\n        loadingCompleteRef.current = null\n      }\n    }\n\n    prevLoadingRef.current = loading\n  }, [loading, data.length, state.hasInitialData, state.isFiltering, actions])\n\n  // -------------------------------------------------------------------------\n  // Handle filter dependency changes\n  // -------------------------------------------------------------------------\n  useEffect(() => {\n    // Skip first render\n    if (isFirstRenderRef.current) {\n      isFirstRenderRef.current = false\n      prevFilterDepsRef.current = filterDependencies\n      return\n    }\n\n    // Check if filter dependencies changed\n    const prevDeps = prevFilterDepsRef.current\n    const hasChanged = filterDependencies.some(\n      (dep, index) => dep !== prevDeps[index]\n    )\n\n    if (hasChanged && state.hasInitialData) {\n      // Filter changed after initial load - show filter skeleton\n      loadingCompleteRef.current = actions.startLoading('filter')\n    }\n\n    prevFilterDepsRef.current = filterDependencies\n  }, [filterDependencies, state.hasInitialData, actions])\n\n  // Cleanup loading complete callback when loading stops\n  // Uses settle delay to prevent flash if loading restarts quickly\n  useEffect(() => {\n    // Clear any pending settle timer when loading state changes\n    if (loadingSettleTimerRef.current) {\n      clearTimeout(loadingSettleTimerRef.current)\n      loadingSettleTimerRef.current = null\n    }\n\n    if (!loading && loadingCompleteRef.current) {\n      const callback = loadingCompleteRef.current\n      loadingCompleteRef.current = null\n\n      // Add small settle delay before completing loading\n      // This prevents skeleton flash if loading restarts immediately\n      const SETTLE_DELAY = 50 // ms\n      loadingSettleTimerRef.current = setTimeout(() => {\n        loadingSettleTimerRef.current = null\n        callback()\n      }, SETTLE_DELAY)\n    }\n  }, [loading])\n\n  // Cleanup timer on unmount\n  useEffect(() => {\n    return () => {\n      if (loadingSettleTimerRef.current) {\n        clearTimeout(loadingSettleTimerRef.current)\n      }\n    }\n  }, [])\n\n  // -------------------------------------------------------------------------\n  // Infinite scroll handler - skeleton stays until hasNextPage=false\n  // Auto-continues pagination when hasNextPage remains true after fetch\n  // -------------------------------------------------------------------------\n  const handleLoadMore = useCallback(async () => {\n    // Guard: prevent concurrent loads\n    if (!fetchMore || isLoadingMoreRef.current) {\n      return\n    }\n\n    // Set loading state\n    isLoadingMoreRef.current = true\n    setIsLoadingMore(true)\n\n    try {\n      await fetchMore()\n    } catch (error) {\n      onFetchMoreError?.(error)\n      // On error, release guard and stop loading\n      isLoadingMoreRef.current = false\n      setIsLoadingMore(false)\n      return\n    }\n\n    // Release guard\n    isLoadingMoreRef.current = false\n\n    // Auto-continue: if hasNextPage is still true, schedule next load\n    // This handles rapid pagination when observer doesn't re-fire\n    // Use setTimeout to allow React to render and update hasNextPageRef\n    setTimeout(() => {\n      if (hasNextPageRef.current && !isLoadingMoreRef.current) {\n        // Use ref to call latest version (avoids stale closure)\n        handleLoadMoreRef.current()\n      } else if (!hasNextPageRef.current) {\n        setIsLoadingMore(false)\n      }\n    }, 50)\n  }, [fetchMore, onFetchMoreError])\n\n  // Keep ref updated with latest handleLoadMore\n  handleLoadMoreRef.current = handleLoadMore\n\n  // Hide skeleton when pagination completes (hasNextPage becomes false)\n  useEffect(() => {\n    if (!hasNextPage && isLoadingMore) {\n      setIsLoadingMore(false)\n    }\n  }, [hasNextPage, isLoadingMore])\n\n  // -------------------------------------------------------------------------\n  // Manual refetch with skeleton\n  // -------------------------------------------------------------------------\n  const refetchWithSkeleton = useCallback(\n    async (refetchFn: () => Promise<unknown>) => {\n      await actions.withLoading('refetch', refetchFn)\n    },\n    [actions]\n  )\n\n  // -------------------------------------------------------------------------\n  // Build infinite scroll config\n  // -------------------------------------------------------------------------\n  const infiniteScrollProps: InfiniteScrollConfig | undefined =\n    fetchMore && hasNextPage !== undefined\n      ? {\n          hasNextPage,\n          isLoadingMore,\n          onLoadMore: handleLoadMore,\n          skeletonRowCount,\n          threshold: loadMoreThreshold,\n        }\n      : undefined\n\n  // -------------------------------------------------------------------------\n  // Compute final loading state\n  // -------------------------------------------------------------------------\n  // Show FULL skeleton when:\n  // 1. Initial loading (no data yet)\n  // 2. Filter change in progress\n  // 3. Refetch in progress with no data\n  // Note: We no longer show full skeleton for batch loading - LoadMoreSkeleton handles that smoothly now\n  const shouldShowSkeleton = (\n    state.isLoading && (\n      !state.hasInitialData || // Initial load\n      state.isFiltering ||      // Filter change\n      (state.isRefetching && data.length === 0) // Refetch with no data\n    )\n  )\n\n  // When clearDataOnLoading is true (default), automatically clear data\n  // during loading so skeleton rows appear. This makes the pattern foolproof.\n  const effectiveData = clearDataOnLoading && shouldShowSkeleton ? [] : data\n\n  return {\n    tableProps: {\n      data: effectiveData,\n      isLoading: shouldShowSkeleton,\n    },\n    // Expose original data for counts, exports, etc.\n    rawData: data,\n    infiniteScrollProps,\n    loadingStates: {\n      isLoading: state.isLoading,\n      isInitialLoading: !state.hasInitialData && state.isLoading,\n      isFiltering: state.isFiltering,\n      isRefetching: state.isRefetching,\n      isLoadingMore,\n      isBatchLoading: isLoadingMore && hasNextPage, // True when actively paginating\n      hasInitialData: state.hasInitialData,\n    },\n    refetchWithSkeleton,\n  }\n}\n"]}